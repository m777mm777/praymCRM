<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GET Request with Multiple Objects</title>
    <style>
        /* Общие стили */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .data-card {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        :root {
            --height-top: calc(11.11vw); /* 11.11% от ширины экрана */
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 1px;
            width: 96.9%;
            height: var(--height-top);
            background-image: url("/images/logo-praym1.jpeg");
            background-size: cover;
            background-position: right;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px 17px;
            border-radius: 10px;
            border: 4px solid black;
        }

        .botton-magrin {
            margin-top: calc(var(--height-top) * 0.16);
        }

        .header-pole-field, .botton-field {
            border-radius: 7px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-right: 10px;
        }

        .label-container {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 17px;
        }

        .label-container input {
            width: 90px;
            margin-right: 10px;
        }

        .label-container input:last-child {
            margin-right: 0;
        }

        .one-field, .two-field {
            border-radius: 10px;
            border: 4px solid black;
        }

        .one-field {
            background-color: #c2c2c2;
        }

        .two-field {
            background-color: #e3e8e6;
        }
    </style>
</head>
<body>

<!-- Фиксированный заголовок -->
<div id="i-container" class="fixed-header">
    <form id="homeForm">
        <button id="fetchButtonHome" class="botton-field" type="button"><- Назад</button>
        <label style="color: white; font-size: 20px; margin-left: 50px;">Сотрудники</label>
    </form><br />
    <select class="header-pole-field" id="responsible" name="responsible" required>
        <option value="" disabled selected>Ответственный</option>
    </select>
    <select class="header-pole-field" id="city" name="city">
        <option value="">Город</option>
        <option value="Москва">Москва</option>
        <option value="Ново-Ебенево">Ново-Ебенево</option>
        <option value="Саратов">Саратов</option>
        <option value="Королев">Королев</option>
        <option value="Питер">Питер</option>
    </select>
    <select class="header-pole-field" id="formaoplaty" name="formaoplaty">
        <option value="">Форма оплаты</option>
        <option value="По ТК">ПО ТК</option>
        <option value="По ТК др-банк">По ТК др банк</option>
        <option value="Самозанятый">Самозанятый</option>
        <option value="Ип">ИП</option>
        <option value="Не официально">Не официально</option>
    </select>
    <select class="header-pole-field" id="dismissed" name="dismissed">
        <option value="">Не уволен</option>
        <option value="true">Уволен</option>
    </select><br />
    <button id="fetchButton" class="botton-field">Получить данные</button>
    <button id="saveAllButton" style="margin-top: 20px;" class="botton-field">Сохранить все</button><br />
    <div class="label-container">
        <input type="text" value="Фамилия" readonly class="chet-field"/>
        <input type="text" value="Имя" readonly class="nechet-field"/>
        <input type="text" value="Отчество" readonly class="chet-field"/>
        <input type="text" value="Телефон" readonly class="nechet-field"/>
        <input type="text" value="Форма занятости" readonly class="chet-field"/>
        <input type="text" value="Город" readonly class="nechet-field"/>
        <input type="text" value="Номер счета" readonly class="chet-field"/>
        <input type="text" value="Ответственный" readonly class="nechet-field"/>
        <input type="text" value="Уволен" readonly class="chet-field"/>
    </div>
</div>

<div id="data-container"></div>

<script>
    const initiatorId = window.location.href.match(/\/super-admin\/get-all-users-by-super-admin\/h\/(\d+)/)?.[1] || null;

    const loadResponsibles = async () => {
        try {
            const response = await fetch(`http://95.142.37.35/super-admin/get-admins/${initiatorId}`);
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();
            const ownerLastNameSelect = document.getElementById('responsible');
            ownerLastNameSelect.innerHTML = '<option value="" disabled selected>Ответственный</option>';
            data.forEach(admin => ownerLastNameSelect.appendChild(new Option(admin, admin)));
        } catch (error) {
            console.error('Ошибка при загрузке списка администраторов:', error);
        }
    };

    const fetchData = async () => {
        try {
            const params = new URLSearchParams({
                responsible: document.getElementById('responsible').value || null,
                city: document.getElementById('city').value || null,
                formaoplaty: document.getElementById('formaoplaty').value || null,
                dismissed: document.getElementById('dismissed').value || null
            });

            const response = await fetch(`http://95.142.37.35/super-admin/all-users-by-super-admin/${initiatorId}?${params}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            document.getElementById('data-container').innerHTML = data.map((item, index) => `
                <div class="data-card ${index % 2 === 0 ? 'one-field' : 'two-field'}">
                    <input type="hidden" id="id-${index}" value="${item.id}" readonly>
                    <input type="text" id="lastName-${index}" value="${item.lastName}" required class="chet-field">
                    <input type="text" id="name-${index}" value="${item.name}" required class="nechet-field">
                    <input type="text" id="patronymic-${index}" value="${item.patronymic}" required class="chet-field">
                    <input type="text" id="phone-${index}" value="${item.phone}" required class="nechet-field">
                    <input type="text" id="category-${index}" value="${item.category}" required class="chet-field">
                    <input type="text" id="city-${index}" value="${item.city}" required class="nechet-field">
                    <input type="text" id="bankAccountNumber-${index}" value="${item.bankAccountNumber}" required class="chet-field">
                    <input type="text" id="ownerLastName-${index}" value="${item.ownerLastName}" required class="nechet-field">
                    <select id="dismissed-${index}" class="chet-field">
                        <option value="true" ${item.dismissed ? 'selected' : ''}>Да</option>
                        <option value="false" ${!item.dismissed ? 'selected' : ''}>Нет</option>
                    </select>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error fetching data:', error);
            alert('Failed to fetch data. Please try again.');
        }
    };

    const saveAllData = async () => {
        const data = Array.from(document.querySelectorAll('.data-card')).map((card, index) => ({
            id: card.querySelector(`#id-${index}`).value,
            name: card.querySelector(`#name-${index}`).value,
            lastName: card.querySelector(`#lastName-${index}`).value,
            patronymic: card.querySelector(`#patronymic-${index}`).value,
            phone: card.querySelector(`#phone-${index}`).value,
            category: card.querySelector(`#category-${index}`).value,
            city: card.querySelector(`#city-${index}`).value,
            bankAccountNumber: card.querySelector(`#bankAccountNumber-${index}`).value,
            ownerLastName: card.querySelector(`#ownerLastName-${index}`).value,
            dismissed: card.querySelector(`#dismissed-${index}`).value === 'true'
        }));

        try {
            const response = await fetch(`http://95.142.37.35/super-admin/update-all-users/${initiatorId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Network response was not ok');
            alert('Данные успешно сохранены!');
        } catch (error) {
            console.error('Error saving data:', error);
            alert('Failed to save data. Please try again.');
        }
    };

    const handleFormSubmit = async (url) => {
        try {
            const response = await fetch(url, { method: 'GET' });
            if (response.ok) {
                const redirectUrl = await response.text();
                window.location.href = `http://95.142.37.35/${redirectUrl}`;
            } else {
                console.error('Ошибка при выполнении запроса:', response.statusText);
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadResponsibles();
        fetchData();
    });

    document.getElementById('fetchButtonHome').addEventListener('click', () => {
        handleFormSubmit(`http://95.142.37.35/super-admin/home-super-admin/${initiatorId}`);
    });

    document.getElementById('fetchButton').addEventListener('click', fetchData);
    document.getElementById('saveAllButton').addEventListener('click', saveAllData);
</script>
</body>
</html>